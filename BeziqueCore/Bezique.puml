@startuml Bezique

/'! $CONFIG : toml
SmRunnerSettings.transpilerId = "CSharp"

[RenderConfig.CSharp]
NameSpace = "BeziqueCore;"
'/

hide empty description
skinparam stateMessageAlignment center

' Game Flow:
' 1. Deal Phase - Deal cards in 3 sets (3-3-3 for 2 players, 3-3-3 for 4 players)
' 2. Select Trump - Flip the trump card
' 3. Play Phase - Players play cards in tricks
'    - 2 player: skip PlayMid
'    - 4 player: PlayFirst -> PlayMid -> PlayLast
' 4. Meld Phase - Winner can declare melds
' 5. NewTrick - Clear played cards, winner leads
' 6. AddOneCardToAll - Each player draws 1 card from deck
' 7. Repeat Play/Meld/NewTrick/Draw until deck empty
' 8. L9Play - Play last 9 cards (no drawing)
' 9. RoundEnd - Calculate scores
' 10. Check for winning score or start new round
'
' Events:
' - Complete: State finished, move to next
' - HasMid: 4 players, has middle player(s)
' - Success: Meld declared successfully
' - Failed: Meld failed or not declared
' - DeckEmpty: No more cards to draw
' - NoCard: Player has no more cards
' - WinningScore: Player reached target score

[*] -> Deal

state Deal {
    [*] -> DealFirst

    state DealFirst
    state DealMid
    state DealLast

    DealFirst : enter / _adapter.DealFirstSet()
    DealFirst -> DealMid : Complete

    DealMid : enter / _adapter.DealMidSet()
    DealMid -> DealLast : Complete

    DealLast : enter / _adapter.DealLastSet()
    DealLast -> SelectTrump : Complete
}

state SelectTrump
SelectTrump : enter / _adapter.SelectTrump()
SelectTrump --> Play : Complete

state Play {
    [*] -> PlayFirst

    state PlayFirst
    state PlayMid
    state PlayLast

    PlayFirst : enter / _adapter.PlayFirstCard()
    PlayFirst -> PlayMid : HasMid
    PlayFirst -> PlayLast : Complete

    PlayMid : enter / _adapter.PlayMidCard()
    PlayMid -> PlayLast : Complete

    PlayLast : enter / _adapter.PlayLastCard()
    PlayLast --> Meld : Complete
}

state Meld {
    [*] -> TryMelded

    state TryMelded
    state Melded
    state NoMeld

    TryMelded : enter / _adapter.TryMeld()
    TryMelded -> Melded : Success
    TryMelded -> NoMeld : Failed

    Melded : enter / _adapter.MeldSuccess()
    Melded -> NewTrick : Complete

    NoMeld : enter / _adapter.MeldFailed()
    NoMeld --> NewTrick : Complete
}

state NewTrick
NewTrick : enter / _adapter.StartNewTrick()
NewTrick -> AddOneCardToAll : Complete

state AddOneCardToAll
AddOneCardToAll : enter / _adapter.DrawCardsForAll()
AddOneCardToAll --> Play : Complete
AddOneCardToAll --> L9Play : DeckEmpty

state L9Play {
    [*] -> L9PlayFirst

    state L9PlayFirst
    state L9PlayMid
    state L9PlayLast

    L9PlayFirst : enter / _adapter.L9PlayFirstCard()
    L9PlayFirst --> L9PlayMid : HasMid
    L9PlayFirst --> L9PlayLast : Complete

    L9PlayMid : enter / _adapter.L9PlayMidCard()
    L9PlayMid --> L9PlayLast : Complete

    L9PlayLast : enter / _adapter.L9PlayLastCard()
    L9PlayLast --> L9NewTrick : Complete
}

state L9NewTrick
L9NewTrick : enter / _adapter.StartL9NewTrick()
L9NewTrick --> L9Play : Complete
L9NewTrick --> RoundEnd : NoCard

state RoundEnd
RoundEnd : enter / _adapter.EndRound()
RoundEnd -> CalculatePoint : Complete

state CalculatePoint
CalculatePoint : enter / _adapter.CalculatePoints()
CalculatePoint --> Deal : Complete
CalculatePoint --> GameOver : WinningScore

state GameOver
GameOver : enter / _adapter.GameOver()

@enduml
