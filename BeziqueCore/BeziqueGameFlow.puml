@startuml

/'! $CONFIG : toml
SmRunnerSettings.transpilerId = "CSharp"
'/

hide empty description
skinparam linetype ortho
skinparam stateMessageAlignment center


state GAME_INIT {
    GAME_INIT: enter / gameAdapter.InitializeGame();
    GAME_INIT: exit / gameAdapter.NotifyGameInitialized();
}

state DEALING {
    DEALING: enter / gameAdapter.DealCards();
    DEALING: exit / gameAdapter.NotifyCardsDealt();
}

state TRUMP_SELECTION {
    TRUMP_SELECTION: enter / gameAdapter.FlipTrumpCard();
    TRUMP_SELECTION: exit / gameAdapter.NotifyTrumpDetermined();
}

state ROUND_END {
    ROUND_END: enter / gameAdapter.CalculateAcesAndTens();
    ROUND_END: enter / gameAdapter.CalculateRoundScores();
    ROUND_END: exit / gameAdapter.NotifyRoundEnded();
}

state GAME_OVER {
    GAME_OVER: enter / gameAdapter.DeclareWinner();
    GAME_OVER: exit / gameAdapter.NotifyGameOver();
}

state TIMER_TIMEOUT {
    TIMER_TIMEOUT: enter / gameAdapter.DeductTimeoutPoints();
    TIMER_TIMEOUT: exit / gameAdapter.ResetPlayerTimer();
}


state GAMEPLAY {
    [*] --> PLAYER_TURN

    state PLAYER_TURN {
        PLAYER_TURN: enter / gameAdapter.StartPlayerTimer();
        PLAYER_TURN: exit / gameAdapter.StopPlayerTimer();
    }

    state OPPONENT_RESPONSE {
        OPPONENT_RESPONSE: enter / gameAdapter.ProcessOpponentResponses();
    }

    state TRICK_RESOLUTION {
        TRICK_RESOLUTION: enter / gameAdapter.ResolveTrick();
    }

    state MELD_OPPORTUNITY {
        MELD_OPPORTUNITY: enter / gameAdapter.ProcessMeldOpportunity();
    }

    state MELD_SCORING {
        MELD_SCORING: enter / gameAdapter.ScoreMeld();
    }

    state CARD_DRAW {
        CARD_DRAW: enter / gameAdapter.DrawCards();
    }

    state DECK_CHECK {
        DECK_CHECK: enter / gameAdapter.CheckDeck();
    }

    PLAYER_TURN --> OPPONENT_RESPONSE : CardPlayed
    OPPONENT_RESPONSE -down-> TRICK_RESOLUTION : TrickComplete
    OPPONENT_RESPONSE -up-> PLAYER_TURN : MorePlayersNeedToPlay
    TRICK_RESOLUTION -down-> MELD_OPPORTUNITY : TrickResolved
    TRICK_RESOLUTION -left-> GAME_OVER : WinningScoreReached
    MELD_OPPORTUNITY -down-> MELD_SCORING : MeldDeclared
    MELD_OPPORTUNITY -right-> CARD_DRAW : MeldSkipped
    MELD_SCORING -down-> CARD_DRAW : MeldScored
    MELD_SCORING -left-> GAME_OVER : WinningScoreReached
    CARD_DRAW -down-> DECK_CHECK : CardsDrawn


    DECK_CHECK -right-> LAST_9_CARDS : DeckEmpty
    DECK_CHECK -up-> PLAYER_TURN : MoreCardsAvailable
}


state LAST_9_CARDS {

    state L9_PLAYER_TURN {
        L9_PLAYER_TURN: enter / gameAdapter.StartPlayerTimer();
        L9_PLAYER_TURN: exit / gameAdapter.StopPlayerTimer();
    }

    state L9_OPPONENT_RESPONSE {
        L9_OPPONENT_RESPONSE: enter / gameAdapter.ProcessL9OpponentResponses();
    }

    state L9_TRICK_RESOLUTION {
        L9_TRICK_RESOLUTION: enter / gameAdapter.ResolveL9Trick();
    }

    state L9_TRICK_CHECK {
        L9_TRICK_CHECK: enter / gameAdapter.CheckL9TrickComplete();
    }

    state L9_TIMER_TIMEOUT {
        L9_TIMER_TIMEOUT: enter / gameAdapter.DeductTimeoutPoints();
        L9_TIMER_TIMEOUT: exit / gameAdapter.ResetPlayerTimer();
    }

    [*] --> L9_PLAYER_TURN
    L9_PLAYER_TURN -down-> L9_OPPONENT_RESPONSE : CardPlayed
    L9_PLAYER_TURN -right-> L9_TIMER_TIMEOUT : TimerExpired
    L9_OPPONENT_RESPONSE -down-> L9_TRICK_RESOLUTION : TrickComplete
    L9_OPPONENT_RESPONSE -up-> L9_PLAYER_TURN : MorePlayersNeedToPlay
    L9_TRICK_RESOLUTION -down-> L9_TRICK_CHECK : TrickResolved
    L9_TRICK_RESOLUTION -left-> GAME_OVER : WinningScoreReached

    L9_TRICK_CHECK -up-> L9_PLAYER_TURN : ContinueLastNine
    L9_TIMER_TIMEOUT -left-> L9_PLAYER_TURN : TimerReset
}


[*] -down-> GAME_INIT
GAME_INIT -down-> DEALING : Initialized
DEALING -down-> TRUMP_SELECTION : CardsDealt
TRUMP_SELECTION -down-> GAMEPLAY : TrumpDetermined


L9_TRICK_CHECK -down-> ROUND_END : AllHandsEmpty
ROUND_END -left-> GAME_INIT : ContinueGame
PLAYER_TURN -right-> TIMER_TIMEOUT : TimerExpired
TIMER_TIMEOUT -left-> PLAYER_TURN : TimerReset

@enduml
